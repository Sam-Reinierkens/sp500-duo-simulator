<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DUO → S&P500 simulator</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  <style>
    :root{
      --bg:#0f1420; --panel:rgba(255,255,255,.06); --text:#e9edf3; --muted:#9fb1c7;
      --accent:#6ea8fe; --accent2:#60d394; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --radius:12px; --radius-input:12px; --chip-w:210px;
      --line-portfolio:#60d394; --line-netto:#8ab4ff; --line-debt:#ff7b7b;
      --thead-bg: color-mix(in oklab, var(--bg), white 6%);
      --firstcol-bg: color-mix(in oklab, var(--bg), white 4%);
      --card-gap:16px;
    }
    body.light{
      --bg:#f4f7fb; --panel:rgba(0,0,0,.04); --text:#0d1117; --muted:#4b5563;
      --accent:#2563eb; --accent2:#16a34a; --line-portfolio:#16a34a; --line-netto:#2563eb; --line-debt:#ef4444;
      --thead-bg:color-mix(in oklab, var(--bg), black 4%);
      --firstcol-bg:color-mix(in oklab, var(--bg), black 2%);
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);
      background:radial-gradient(1200px 600px at 80% -10%, rgba(110,168,254,.20), transparent 60%),
                 radial-gradient(1000px 800px at 0% 100%, rgba(96,211,148,.20), transparent 60%), var(--bg);}    
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(14px) saturate(140%);
      background:linear-gradient(180deg, color-mix(in oklab, var(--bg), #000 10%), color-mix(in oklab, var(--bg), transparent 40%));
      border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:1.35rem}
    .sub{color:var(--muted);font-size:.92rem}

    .grid{display:grid;gap:var(--card-gap);grid-template-columns:minmax(360px,1fr) minmax(720px,1.6fr)}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:hidden}
    .card-settings{overflow:hidden}
    .card h2{margin:0 0 10px;font-size:1.05rem}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--muted);font-size:.85rem;line-height:1}
    .badge.on{color:#fff;border-color:color-mix(in oklab,var(--accent),#fff 10%);background:color-mix(in oklab,var(--accent),transparent 85%)}

    /* Grid item mag krimpen: voorkomt overflow van date-inputs */
    .controls{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:16px;align-items:start}
    .controls > .field{min-width:0}
    .field{display:grid;grid-template-rows:auto 44px;gap:6px}
    .field label{font-size:.9rem;color:var(--muted);line-height:1.2}

    input[type="number"], input[type="date"], select{
      height:44px;width:100%;display:block;border-radius:var(--radius-input);border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.06);color:var(--text);padding:0 12px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
      font-variant-numeric:tabular-nums;transition:box-shadow .2s,border-color .2s,background .2s
    }
    input[type="number"]:focus,input[type="date"]:focus,select:focus{border-color:color-mix(in oklab,var(--accent),#fff 10%); box-shadow:0 0 0 3px color-mix(in oklab,var(--accent),transparent 85%)}

    body.light input[type="number"], body.light input[type="date"], body.light select{
      background:#ffffff; border:1px solid rgba(0,0,0,.12);
      box-shadow:0 2px 6px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.5);
    }

    /* --- iOS Safari: date-input die “uitsteekt” fixen --- */
    input[type="date"]{
      -webkit-appearance:none; appearance:none;        /* dwing consistent boxmodel */
      min-width:0; max-width:100%;                     /* nooit breder dan de kolom */
      overflow:hidden;                                  /* clip eventuele native overflow */
      background-clip:padding-box;                      /* geen bleed over de rand */
    }
    /* Subparts in WebKit zodat hij netjes binnen 44px past */
    input[type="date"]::-webkit-datetime-edit{ padding:0 2px; }
    input[type="date"]::-webkit-date-and-time-value{ min-height:44px; line-height:44px; }
    input[type="date"]::-webkit-calendar-picker-indicator{ margin:0; padding:0 6px 0 0; }
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button{ display:none; }

    .row-slider{grid-column:1/-1;display:grid;grid-template-columns:auto 1fr 92px;gap:12px;align-items:center}
    input[type="range"]{height:36px;accent-color:var(--accent)}
    .slider-val{font-variant-numeric:tabular-nums;color:var(--muted);min-width:72px;text-align:right}

    .toggles{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0;justify-content:flex-start}
    .tgl{display:inline-flex;gap:10px;align-items:center;user-select:none;cursor:pointer;padding:6px 16px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);height:44px;min-width:var(--chip-w);justify-content:flex-start}
    .tgl input{position:absolute;opacity:0;width:1px;height:1px}
    .tgl .track{position:relative;width:60px;height:28px;border-radius:999px;background:rgba(255,255,255,.14);box-shadow:inset 0 1px 2px rgba(0,0,0,.25);transition:background .2s;flex:0 0 60px;margin-right:10px}
    .tgl .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#d1d5db;transition:transform .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    .tgl input:checked + .track{background:color-mix(in oklab,var(--accent),white 8%)}
    .tgl input:checked + .track .thumb{transform:translateX(32px);background:#fff}
    .tgl .txt{font-size:.92rem;white-space:nowrap}
    .controls .field .tgl{width:100%;min-width:0;justify-content:flex-start}

    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;align-items:stretch}
    @media(max-width:1100px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);display:grid;grid-template-rows:auto 1fr auto;aspect-ratio:1/1;overflow:hidden}
    .kpi .label{color:var(--muted);font-size:.95rem;font-weight:600}
    .kpi .value{font-size:1.35rem;font-variant-numeric:tabular-nums;margin-top:6px}
    .kpi .tag{margin-top:10px;font-size:.88rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis}

    .chart-wrap{position:relative;width:100%;height:360px}
    @media(max-width:980px){.chart-wrap{height:280px}}
    #chart{display:block;width:100% !important;height:100% !important}

    .tbl-wrap{overflow:auto;max-height:55vh;border-radius:var(--radius);border:1px solid rgba(255,255,255,.06)}
    table{width:100%;border-collapse:separate;border-spacing:0;font-variant-numeric:tabular-nums}
    td,th{padding:10px;border-bottom:1px dashed rgba(255,255,255,.08);text-align:right;background:transparent}
    thead th{color:var(--muted);font-weight:600;position:sticky;top:0;z-index:3;background:var(--thead-bg);backdrop-filter:saturate(130%) blur(4px);box-shadow:inset 0 -1px 0 rgba(255,255,255,.08)}
    th:first-child,td:first-child{position:sticky;left:0;z-index:2;background:var(--firstcol-bg);text-align:left;min-width:120px}
    thead th:first-child{z-index:4}

    #seriesToggles{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;align-items:stretch;margin:10px 0}
    #seriesToggles .tgl{min-width:0;width:100%;justify-content:flex-start;align-items:center;text-align:left;padding-inline:12px}
    #seriesToggles .track{margin-right:10px}
    @media(max-width:900px){#seriesToggles{grid-template-columns:1fr 1fr}}
    @media(max-width:560px){#seriesToggles{grid-template-columns:1fr}}

    .inline-pair{display:flex;gap:8px;align-items:center}
    .inline-pair input[type="number"]{flex:1}
    .inline-pair select{flex:1;min-width:0}
    .inline-pair .tgl{min-width:unset;padding-inline:10px;height:44px}
    .field-full{grid-column:1/-1}

    /* ===== Mobile-only layout fixes (desktop ongewijzigd) ===== */
    @media (max-width: 720px){
      .wrap{padding:14px}
      .controls{grid-template-columns:1fr}
      .row-slider{grid-template-columns:1fr; gap:8px}
      .row-slider .slider-val{justify-self:end}
      .toggles{flex-direction:column; align-items:stretch}
      .toggles .tgl{min-width:0; width:100%}
      .tgl .txt{white-space:normal}
      .chart-wrap{height:260px}
    }
    @media (max-width: 380px){
      .chart-wrap{height:220px}
      table{font-size:14px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>DUO → S&P500 simulator</h1>
      <div class="sub">Simuleer lenen bij DUO en beleggen in de S&P 500 — lokaal en realtime.</div>
    </div>
  </header>

  <main class="wrap" style="padding-top:14px;">
    <div class="grid">
      <!-- INSTELLINGEN -->
      <section class="card card-settings">
        <h2>Instellingen</h2>
        <div class="controls">
          <div class="field">
            <label>Maandbedrag lenen (€)</label>
            <input id="inpAmount" type="number" min="0" step="1" value="942.42" />
          </div>
          <div class="field">
            <label>DUO-rente per jaar (%)</label>
            <input id="inpLoanAPR" type="number" min="0" step="0.01" value="2.57" />
          </div>
          <div class="field">
            <label>Startdatum lening (eerste uitkering)</label>
            <input id="inpStart" type="date" />
          </div>
          <div class="field">
            <label>Einde studie / laatste DUO-uitkering</label>
            <input id="inpEnd" type="date" />
          </div>

          <div class="row-slider">
            <label for="inpRepayYears">Looptijd terugbetaling (jaren)</label>
            <input id="inpRepayYears" type="range" min="1" max="35" step="1" value="35" />
            <div class="slider-val" id="repayYearsOut">35 jaar</div>
          </div>

          <div class="row-slider">
            <label for="inpInvestYears">Beleggingshorizon (jaren)</label>
            <input id="inpInvestYears" type="range" min="1" max="50" step="1" value="39" />
            <div class="slider-val" id="investYearsOut">39 jaar</div>
          </div>

          <div class="field">
            <label>Verwacht rendement p/j (%)</label>
            <input id="inpReturnAPR" type="number" step="0.1" min="0" value="8" />
          </div>
          <div class="field">
            <label>Initiële eigen inleg (€)</label>
            <input id="inpInitialOwn" type="number" min="0" step="1" value="0" />
          </div>

          <div class="field">
            <label>Eigen inleg (€)</label>
            <input id="inpOwn" type="number" min="0" step="1" value="0" />
          </div>
          <div class="field">
            <label>Frequentie eigen inleg</label>
            <select id="selOwnFreq">
              <option value="monthly" selected>Maandelijks</option>
              <option value="weekly">Wekelijks</option>
              <option value="off">Uit</option>
            </select>
          </div>

          <div class="field">
            <label>Inflatie p/j (%)</label>
            <input id="inpInflAPR" type="number" min="0" step="0.1" value="2.1" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <label class="tgl" id="tglInflWrap" aria-label="Reëel tonen" role="switch" aria-checked="false">
              <input id="tglInfl" type="checkbox" />
              <span class="track"><span class="thumb"></span></span>
              <span class="txt">Reëel tonen</span>
            </label>
          </div>

          <div class="field">
            <label>USD/EUR totaal (%)</label>
            <input id="inpFXAPR" type="number" step="0.1" value="0" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <label class="tgl" id="tglFXWrap" aria-label="FX toepassen" role="switch" aria-checked="false">
              <input id="tglFX" type="checkbox" />
              <span class="track"><span class="thumb"></span></span>
              <span class="txt">FX toepassen</span>
            </label>
          </div>
        </div>

        <div class="toggles">
          <label class="tgl" id="tglPayWrap" role="switch" aria-checked="false">
            <input id="tglPay" type="checkbox" />
            <span class="track"><span class="thumb"></span></span>
            <span class="txt">Schuld betalen uit portefeuille</span>
          </label>
          <label class="tgl" id="tglDarkWrap" role="switch" aria-checked="true">
            <input id="tglDark" type="checkbox" checked />
            <span class="track"><span class="thumb"></span></span>
            <span class="txt">Donkere modus</span>
          </label>
        </div>

        <div class="sub" style="margin-top:6px">
          Fases volgens DUO: <strong>rente maandelijks samengesteld</strong>. Tijdens studie rente <strong>per kalenderjaar</strong>.
          <strong>Aanloopfase</strong>: 1 januari na je laatste DUO-maand t/m 31 december twee jaar later. <strong>Aflossen</strong> start 1 januari daarna (rente 5 jaar vast per blok).
        </div>
        <div class="toolbar" style="margin-top:12px; gap:8px; flex-wrap:wrap; display:flex;">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </section>

      <!-- SIMULATIE -->
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap; margin-bottom:6px;">
          <h2 style="margin:0">Simulatie</h2>
          <span id="viewModeBadge" class="badge">Nominaal</span>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="label">Totale inleg</div><div class="value" id="kInleg">€ 0</div><div class="tag" id="kMonths">—</div></div>
          <div class="kpi"><div class="label">Totale extern betaalde DUO</div><div class="value" id="kExternal">€ 0</div><div class="tag">Aflossingen buiten portefeuille</div></div>
          <div class="kpi"><div class="label">Eindwaarde portefeuille</div><div class="value" id="kPort">€ 0</div><div class="tag" id="kPortTag">—</div></div>
          <div class="kpi"><div class="label">Netto resultaat</div><div class="value" id="kNetto">€ 0</div><div class="tag">≈ Eindportefeuille – extern betaalde DUO</div></div>
        </div>

        <div class="toggles" id="seriesToggles">
          <label class="tgl" id="wrapNet" role="switch" aria-checked="false"><input id="togNet" type="checkbox"><span class="track"><span class="thumb"></span></span><span class="txt">Netto</span></label>
          <label class="tgl" id="wrapPort" role="switch" aria-checked="true"><input id="togPort" type="checkbox" checked><span class="track"><span class="thumb"></span></span><span class="txt">Portefeuille</span></label>
          <label class="tgl" id="wrapDebt" role="switch" aria-checked="false"><input id="togDebt" type="checkbox"><span class="track"><span class="thumb"></span></span><span class="txt">Schuld (overlay)</span></label>
        </div>

        <div class="chart-wrap"><canvas id="chart"></canvas></div>
        <div class="sub" style="margin-top:10px" id="phaseNote">—</div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:6px;">
        <h2 style="margin:0">Maandelijkse details</h2>
        <div style="display:flex; gap:8px; align-items:center; margin-top:-4px;">
          <span class="sub">Weergave</span>
          <select id="selTableView">
            <option value="month" selected>Maandelijks</option>
            <option value="quarter">Per kwartaal</option>
            <option value="year">Per jaar (kalender)</option>
          </select>
        </div>
      </div>
      <div class="tbl-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="min-width:120px">Periode</th>
              <th>Totale inleg (€)</th>
              <th>DUO-inleg (€)</th>
              <th>Eigen inleg (€)</th>
              <th>Aflossing DUO (€)</th>
              <th>Extern betaald (€)</th>
              <th>Rente DUO (optelsom) (€)</th>
              <th>Schuld einde periode (€)</th>
              <th>Portefeuille einde periode (€)</th>
              <th>Saldo (portf − schuld) (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const gi = (id) => document.getElementById(id);
    const setText = (id, txt) => { const el = gi(id); if (el) el.textContent = txt; };
    const setHTML = (id, html) => { const el = gi(id); if (el) el.innerHTML = html; };
    const euro = (v) => v.toLocaleString('nl-NL', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const euro2 = (v) => v.toLocaleString('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const getCSS = (n) => getComputedStyle(document.body).getPropertyValue(n).trim();
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    function addMonths(date, n) { const d = new Date(date.getTime()); const day = d.getDate(); d.setMonth(d.getMonth() + n); if (d.getDate() !== day) d.setDate(0); return d; }
    function monthsBetween(a, b) { let y = b.getFullYear() - a.getFullYear(); let m = b.getMonth() - a.getMonth(); let t = y * 12 + m; if (b.getDate() < a.getDate()) t -= 1; return Math.max(0, t); }
    function monthsInclusive(start, end) { let c = 0, cur = new Date(start); while (cur <= end) { c++; cur = addMonths(cur, 1); } return c; }
    const ymd = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    // ===== Known DUO rates (SF35) per kalenderjaar / blok-startjaar =====
    // Voor jaren die hier niet instaan wordt inpLoanAPR gebruikt.
    const RATES_BY_YEAR = {
      2024: 0.0256,
      2025: 0.0257
    };

    function blockStartYearFor(date, end){
      const y1 = end.getFullYear() + 1;
      const k = Math.floor((date.getFullYear() - y1) / 5);
      return y1 + k * 5;
    }

    function monthlyLoanRate(end, defaultAPR, date){
      const y = date.getFullYear();
      const janAfter = new Date(end.getFullYear()+1,0,1);
      let apr;
      if (date < janAfter){
        apr = (RATES_BY_YEAR[y] ?? defaultAPR);
      } else {
        const by = blockStartYearFor(date, end);
        apr = (RATES_BY_YEAR[by] ?? defaultAPR);
      }
      return Math.pow(1 + apr, 1/12) - 1;
    }

    function phases(end){
      const graceStart = new Date(end.getFullYear()+1,0,1);
      const graceEnd   = new Date(end.getFullYear()+2,11,31);
      const repayStart = new Date(end.getFullYear()+3,0,1);
      return { graceStart, graceEnd, repayStart };
    }

    // ===== Read inputs =====
    function getInputs() {
      const amount = Math.max(0, Number(gi('inpAmount')?.value?.replace(',', '.') ?? 0) || 0);
      const loanAPR = Math.max(0, Number(gi('inpLoanAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const inflAPR = Math.max(0, Number(gi('inpInflAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const fxTotal = (Number(gi('inpFXAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const startStr = gi('inpStart')?.value || '';
      const endStr = gi('inpEnd')?.value || '';
      const start = startStr ? new Date(startStr) : new Date();
      const end = endStr ? new Date(endStr) : new Date();
      const expAPR = Math.max(0, Number(gi('inpReturnAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const repayYears = clamp(parseInt(gi('inpRepayYears')?.value || '35', 10), 1, 35);
      const investYears = clamp(parseInt(gi('inpInvestYears')?.value || '39', 10), 1, 50);
      const ownAmount = Math.max(0, Number(gi('inpOwn')?.value?.replace(',', '.') ?? 0) || 0);
      const initialOwn = Math.max(0, Number(gi('inpInitialOwn')?.value?.replace(',', '.') ?? 0) || 0);
      const ownFreq = gi('selOwnFreq')?.value || 'monthly';
      const payFromPortfolio = !!gi('tglPay')?.checked;
      const inflOn = !!gi('tglInfl')?.checked;
      const fxOn = !!gi('tglFX')?.checked;
      const tableView = gi('selTableView')?.value || 'month';
      return { amount, start, end, loanAPR, expAPR, repayYears, investYears, ownAmount, ownFreq, initialOwn, payFromPortfolio, inflOn, inflAPR, fxOn, fxTotal, tableView };
    }

    // ===== Core simulation (met DUO-fases & rentevast) =====
    function simulate(cfg) {
      const rI = Math.pow(1 + cfg.expAPR, 1 / 12) - 1;
      const monthsBorrowed = monthsInclusive(cfg.start, cfg.end);
      const { graceStart, graceEnd, repayStart } = phases(cfg.end);
      const repayStartIdx = monthsBetween(cfg.start, repayStart);
      const repayMonths = cfg.repayYears * 12;
      const monthsInvest = cfg.investYears * 12;

      const totalMonths = monthsInvest;

      let principalDry = 0;
      for(let i=0;i<repayStartIdx;i++){
        const date = addMonths(cfg.start, i);
        const rL = monthlyLoanRate(cfg.end, cfg.loanAPR, date);
        const c = (i < monthsBorrowed) ? cfg.amount : 0;
        principalDry += c;
        principalDry += principalDry * rL;
      }
      const B0 = principalDry;

      const blockChangeIdxs = [];
      let nextBlock = new Date(cfg.end.getFullYear()+1, 0, 1);
      while (nextBlock <= addMonths(repayStart, repayMonths)) {
        if (nextBlock >= repayStart) {
          const idx = monthsBetween(cfg.start, nextBlock);
          if (idx >= repayStartIdx && idx < repayStartIdx + repayMonths) blockChangeIdxs.push(idx);
        }
        nextBlock = new Date(nextBlock.getFullYear()+5, 0, 1);
      }

      const ownMonthly = (cfg.ownFreq==='monthly') ? cfg.ownAmount : (cfg.ownFreq==='weekly' ? cfg.ownAmount * (52/12) : 0);

      let principal=0;
      let portD=0, portO=cfg.initialOwn||0;
      let totalInterest=0, totalInleg=0, totalDUOInleg=0, totalOwnInleg=0;
      const labels=[], arrPort=[], arrDebt=[], arrNet=[], arrPay=[], arrInt=[], arrExternalPay=[], arrPortfolioPay=[], arrInlegDuo=[], arrInlegOwn=[], arrInlegTotal=[];
      let depletedAt=null;

      let currentPayment = 0;

      for (let i=0;i<totalMonths;i++){
        const date = addMonths(cfg.start, i);
        labels.push(`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`);

        const rL = monthlyLoanRate(cfg.end, cfg.loanAPR, date);

        const cDuo = (i < monthsBorrowed) ? cfg.amount : 0;
        const starter = (i===0 ? (cfg.initialOwn||0) : 0);
        const cOwn = (i < monthsInvest) ? ownMonthly : 0;
        portD += cDuo; portO += (starter + cOwn);
        totalDUOInleg += cDuo; totalOwnInleg += (starter + cOwn); totalInleg += (cDuo + starter + cOwn);
        arrInlegDuo.push(cDuo); arrInlegOwn.push(starter + cOwn); arrInlegTotal.push(cDuo + starter + cOwn);

        principal += cDuo;
        const interest = principal * rL;
        principal += interest;
        totalInterest += interest;
        arrInt.push(interest);

        let pay=0, payFromPort=0, payExternal=0;
        if (i >= repayStartIdx) {
          const monthsSinceRepay = i - repayStartIdx;
          const remaining = Math.max(0, repayMonths - monthsSinceRepay);
          const isBlockChange = (monthsSinceRepay === 0) || blockChangeIdxs.includes(i);
          if (isBlockChange && remaining > 0){
            const rForBlock = rL;
            currentPayment = (rForBlock > 0) ? (principal * (rForBlock / (1 - Math.pow(1 + rForBlock, -remaining)))) : (principal / remaining);
          }
          pay = Math.min(currentPayment, principal);
          principal -= pay;
        }

        const portTotalBefore = portD + portO;
        if (cfg.payFromPortfolio && pay>0 && portTotalBefore>0){
          const payUse = Math.min(pay, portTotalBefore);
          const shareD = portD / portTotalBefore; const shareO = 1 - shareD;
          portD -= payUse * shareD; portO -= payUse * shareO;
          payFromPort = payUse;
          if (payUse < pay) payExternal = pay - payUse;
          if ((portD + portO) <= 0 && depletedAt === null){ depletedAt = date; portD = Math.max(0, portD); portO = Math.max(0, portO); }
        } else {
          payExternal = pay;
        }

        portD *= (1 + rI); portO *= (1 + rI);

        const portTotal = portD + portO;
        const net = portTotal - principal;
        arrPort.push(portTotal||0); arrDebt.push(principal||0); arrNet.push(net||0);
        arrPay.push(pay||0); arrExternalPay.push(payExternal||0); arrPortfolioPay.push(payFromPort||0);
      }

      if (cfg.fxOn && cfg.fxTotal !== 0){
        const f = 1 + cfg.fxTotal;
        for (let i=0;i<arrPort.length;i++){ arrPort[i]*=f; arrNet[i]*=f; }
      }

      const endPortfolio = arrPort[arrPort.length-1] || 0; 
      const endDebt = arrDebt[arrDebt.length-1] || 0;
      const totalPaid = arrPay.reduce((a,b)=>a+b,0);
      const totalExternal = arrExternalPay.reduce((a,b)=>a+b,0);
      const totalFromPortfolio = arrPortfolioPay.reduce((a,b)=>a+b,0);

      return { labels, arrPort, arrDebt, arrNet, arrPay, arrInt, arrExternalPay, arrPortfolioPay, arrInlegDuo, arrInlegOwn, arrInlegTotal,
        totals: { monthsBorrowed, monthsInvest, totalInleg, totalDUOInleg, totalOwnInleg, totalInterest, endPortfolio, endDebt, totalPaid, totalExternal, totalFromPortfolio, netResult: endPortfolio - totalExternal },
        meta: { grad: cfg.end, graceStart, graceEnd, repayStartDate: repayStart, monthlyPayment: currentPayment, depletedAt, repayEndDate: addMonths(repayStart, repayMonths), investEndDate: addMonths(cfg.start, monthsInvest) } };
    }

    // ===== Deflatie helper =====
    function deflateView(sim, inflAPR){
      const rInf = Math.pow(1 + inflAPR, 1/12) - 1;
      const df = (i) => 1 / Math.pow(1 + rInf, i);
      const mapA = (arr) => arr.map((v,i)=> v*df(i));
      return {
        ...sim,
        arrPort: mapA(sim.arrPort),
        arrDebt: mapA(sim.arrDebt),
        arrNet:  mapA(sim.arrNet),
        arrPay:  mapA(sim.arrPay),
        arrInt:  mapA(sim.arrInt),
        arrExternalPay: mapA(sim.arrExternalPay),
        arrPortfolioPay: mapA(sim.arrPortfolioPay),
        arrInlegDuo: mapA(sim.arrInlegDuo),
        arrInlegOwn: mapA(sim.arrInlegOwn),
        arrInlegTotal: mapA(sim.arrInlegTotal)
      };
    }

    // ===== Tabel-aggregatie =====
    function groupRows(sim){
      const mode=gi('selTableView')?.value||'month';
      const rows=[];
      const pushRow=(key,idxs, cumRente)=>{
        const lastIdx=idxs[idxs.length-1];
        const sum=(arr)=>idxs.reduce((a,i)=>a+(arr[i]||0),0);
        rows.push({ key,
          inleg: sum(sim.arrInlegTotal), inlegDuo: sum(sim.arrInlegDuo), inlegOwn: sum(sim.arrInlegOwn),
          pay: sum(sim.arrPay), external: sum(sim.arrExternalPay), rente: cumRente,
          schuld: sim.arrDebt[lastIdx], port: sim.arrPort[lastIdx], saldo: sim.arrNet[lastIdx]
        });
      };

      if (mode==='month'){
        // cumulatieve rente t/m die maand
        let running = 0;
        for (let i=0;i<sim.labels.length;i++){
          running += (sim.arrInt[i]||0);
          pushRow(sim.labels[i], [i], running);
        }
      } else if (mode==='quarter'){
        // totale rente per kwartaal
        const groups={};
        for (let i=0;i<sim.labels.length;i++){
          const d=addMonths(new Date(gi('inpStart')?.value||Date.now()), i);
          const q=Math.floor(d.getMonth()/3)+1;
          const key=`${d.getFullYear()} Q${q}`;
          if(!groups[key]) groups[key]=[];
          groups[key].push(i);
        }
        Object.keys(groups).forEach(k=>{
          const idxs=groups[k];
          const rente = idxs.reduce((a,i)=>a+(sim.arrInt[i]||0),0);
          pushRow(k, idxs, rente);
        });
      } else {
        // totale rente per kalenderjaar
        const groups={};
        for (let i=0;i<sim.labels.length;i++){
          const d=addMonths(new Date(gi('inpStart')?.value||Date.now()), i);
          const key=`${d.getFullYear()}`;
          if(!groups[key]) groups[key]=[];
          groups[key].push(i);
        }
        Object.keys(groups).forEach(k=>{
          const idxs=groups[k];
          const rente = idxs.reduce((a,i)=>a+(sim.arrInt[i]||0),0);
          pushRow(k, idxs, rente);
        });
      }
      return rows;
    }

    // ===== Chart =====
    let chart;
    function ensureChart(){
      if (chart) return chart;
      const ctx = gi('chart');
      if (!ctx || !window.Chart) return null;
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [
          { label:'Portefeuille', data: [], tension:.25, borderWidth:1.8, fill:false, borderColor:getCSS('--line-portfolio'), pointRadius:0, pointHitRadius:18, pointHoverRadius:3, hidden:false },
          { label:'Netto', data: [], tension:.25, borderWidth:1.8, fill:false, borderColor:getCSS('--line-netto'), pointRadius:0, pointHitRadius:18, pointHoverRadius:3, hidden:true },
          { label:'Schuld (overlay)', data: [], tension:.2, borderWidth:1.2, fill:false, borderColor:getCSS('--line-debt'), pointRadius:0, pointHitRadius:18, pointHoverRadius:3, borderDash:[6,4], hidden:true }
        ]},
        options: {
          responsive:true,
          maintainAspectRatio:false,
          animations:{ duration:200 },
          interaction:{ mode:'index', intersect:false, axis:'x' },
          elements:{ point:{ radius:0, hitRadius:18, hoverRadius:3 } },
          plugins:{
            legend:{ display:false },
            tooltip:{ callbacks:{ label:(ctx)=>{ const ds=ctx.dataset.label; const v=ctx.parsed.y||0; return `${ds}: ${euro2(v)}`; } } }
          },
          scales:{ y:{ beginAtZero:false }, x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:10 } } }
        }
      });
      return chart;
    }
    const applyChartTheme=()=>{ if(!chart) return; const d=chart.data.datasets; d[0].borderColor=getCSS('--line-portfolio'); d[1].borderColor=getCSS('--line-netto'); d[2].borderColor=getCSS('--line-debt'); chart.update('none'); };

    // ===== Renderers =====
    function renderTable(sim){
      const tbody=document.querySelector('#tbl tbody'); if(!tbody) return; const rows=groupRows(sim);
      tbody.innerHTML=rows.map(r=>`<tr>
        <td>${r.key}</td>
        <td>${euro2(r.inleg)}</td>
        <td>${euro2(r.inlegDuo)}</td>
        <td>${euro2(r.inlegOwn)}</td>
        <td>${euro2(r.pay)}</td>
        <td>${euro2(r.external)}</td>
        <td>${euro2(r.rente)}</td>
        <td>${euro2(r.schuld)}</td>
        <td>${euro2(r.port)}</td>
        <td>${euro2(r.saldo)}</td>
      </tr>`).join('');
    }

    function update(){
      setText('repayYearsOut', `${gi('inpRepayYears')?.value||''} jaar`);
      setText('investYearsOut', `${gi('inpInvestYears')?.value||''} jaar`);

      const cfg=getInputs();
      const simNomFX = simulate(cfg);
      const sim = cfg.inflOn ? deflateView(simNomFX, cfg.inflAPR) : simNomFX;

      const last = sim.labels.length - 1;
      const sum = (a)=>a.reduce((x,y)=>x+y,0);
      const totalInleg = sum(sim.arrInlegTotal);
      const totalExternal = sum(sim.arrExternalPay);
      const endPortfolio = sim.arrPort[last]||0;
      const netResult = endPortfolio - totalExternal;

      setText('kInleg', euro(totalInleg));
      const ownActive = sum(sim.arrInlegOwn)>0 ? ' • eigen inleg actief' : '';
      setText('kMonths', `${simNomFX.totals.monthsBorrowed} maanden DUO${ownActive}`);
      setText('kPort', euro(endPortfolio));
      setText('kExternal', euro(totalExternal));
      setText('kNetto', euro(netResult));
      const badge = gi('viewModeBadge');
      if (badge){ if (cfg.inflOn){ badge.textContent = 'Reëel (inflatie)'; badge.classList.add('on'); } else { badge.textContent = 'Nominaal'; badge.classList.remove('on'); } }
      setText('kPortTag', cfg.payFromPortfolio ? (simNomFX.meta.depletedAt?`Aflossingen uit portefeuille • leeg in ${simNomFX.meta.depletedAt.getFullYear()}-${String(simNomFX.meta.depletedAt.getMonth()+1).padStart(2,'0')}`:'Aflossingen uit portefeuille') : 'Aflossingen extern betaald');

      const fmt=(d)=>ymd(d);
      const outside = monthsBetween(simNomFX.meta.repayStartDate, simNomFX.meta.repayEndDate) + monthsBetween(cfg.start, simNomFX.meta.repayStartDate) > cfg.investYears*12;
      const repayNote = outside
        ? `• <em>Aflossen loopt door tot</em>: <strong>${fmt(simNomFX.meta.repayEndDate)}</strong> (buiten weergave)`
        : `• Einde aflossen: <strong>${fmt(simNomFX.meta.repayEndDate)}</strong>`;
      setHTML('phaseNote', `Laatste DUO-maand: <strong>${fmt(simNomFX.meta.grad)}</strong> • Aanloopfase: <strong>${fmt(simNomFX.meta.graceStart)}</strong> t/m <strong>${fmt(simNomFX.meta.graceEnd)}</strong> • Start aflossen: <strong>${fmt(simNomFX.meta.repayStartDate)}</strong> • Eerste maandtermijn (blok): <strong>${euro2(simNomFX.meta.monthlyPayment)}</strong> ${repayNote} • <em>Beleggingshorizon eindigt</em>: <strong>${fmt(simNomFX.meta.investEndDate)}</strong>${cfg.inflOn?' • weergave: reëel (prijspeil startdatum)':''}`);

      renderTable(sim);

      const ch = ensureChart();
      if (ch){
        ch.data.labels = sim.labels;
        ch.data.datasets[0].data = sim.arrPort;
        ch.data.datasets[1].data = sim.arrNet;
        ch.data.datasets[2].data = sim.arrDebt.map(v=>-v);

        ch.data.datasets[0].hidden = !gi('togPort')?.checked;
        ch.data.datasets[1].hidden = !gi('togNet')?.checked;
        ch.data.datasets[2].hidden = !gi('togDebt')?.checked;

        let yMin = 0; if (gi('togDebt')?.checked){ const minDebt = Math.min(...ch.data.datasets[2].data, 0); yMin = Math.floor((minDebt*1.05)/100)*100; }
        const visible = []; if(gi('togPort')?.checked) visible.push(...ch.data.datasets[0].data); if(gi('togNet')?.checked) visible.push(...ch.data.datasets[1].data); const yMax = visible.length? Math.max(...visible, 0) : 0;
        ch.options.scales.y.min = yMin; ch.options.scales.y.suggestedMax = yMax*1.05;
        ch.update(); applyChartTheme();
      }
    }

    // ===== Events & defaults =====
    function setDefaultDates(){
      // Defaults: start 24-09-2024, einde in augustus: 24-08-2026
      const start=new Date('2024-09-24');
      const end=new Date('2026-08-24');
      const s=gi('inpStart'); const e=gi('inpEnd');
      if(s) s.value=`${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;
      if(e) e.value=`${end.getFullYear()}-${String(end.getMonth()+1).padStart(2,'0')}-${String(end.getDate()).padStart(2,'0')}`;
    }

    function wireToggleInput(inputId, wrapId, onChange){ const inp=gi(inputId); const wrap=gi(wrapId); if(!inp||!wrap) return; const sync=()=>wrap.setAttribute('aria-checked', String(!!inp.checked)); inp.addEventListener('change', ()=>{ if(inputId==='tglDark'){ document.body.classList.toggle('light', !inp.checked); } sync(); onChange&&onChange(); }); sync(); }
    function wireChartToggle(id,wrapId){ const inp=gi(id); const wrap=gi(wrapId); if(!inp||!wrap) return; const sync=()=>wrap.setAttribute('aria-checked', String(!!inp.checked)); inp.addEventListener('change', ()=>{ sync(); update(); }); sync(); }

    function wireInputs(){
      ['inpAmount','inpLoanAPR','inpStart','inpEnd','inpRepayYears','inpInvestYears','inpReturnAPR','selOwnFreq','inpOwn','inpInitialOwn','selTableView','inpInflAPR','inpFXAPR']
        .forEach(id=>{ const el=gi(id); if(!el) return; el.addEventListener('input',()=>{ update(); }); el.addEventListener('change', update); });
      wireToggleInput('tglPay','tglPayWrap', update);
      wireToggleInput('tglInfl','tglInflWrap', update);
      wireToggleInput('tglFX','tglFXWrap', update);
      wireToggleInput('tglDark','tglDarkWrap', ()=>{ applyChartTheme(); update(); });
      wireChartToggle('togNet','wrapNet'); wireChartToggle('togPort','wrapPort'); wireChartToggle('togDebt','wrapDebt');
      const btn=gi('btnReset'); if(btn){ btn.addEventListener('click', (e)=>{ e.preventDefault(); setDefaultDates(); const set=(id,val)=>{ const el=gi(id); if(el) el.value=val; }; set('inpAmount',942.42); set('inpLoanAPR',2.57); set('inpReturnAPR',8); set('inpRepayYears',35); set('inpInvestYears',39); setText('repayYearsOut','35 jaar'); setText('investYearsOut','39 jaar'); set('inpOwn',0); set('inpInitialOwn',0); const of=gi('selOwnFreq'); if(of) of.value='monthly'; set('inpInflAPR',2.1); set('inpFXAPR',0); const ck=(id,val)=>{ const el=gi(id); if(el){ el.checked=val; el.dispatchEvent(new Event('change')); } }; ck('tglPay',false); ck('tglInfl',false); ck('tglFX',false); ck('tglDark',true); ck('togNet',false); ck('togPort',true); ck('togDebt',false); update(); }); }
    }

    function selfTests(){
      try{
        console.assert(monthsBetween(new Date('2024-01-24'), new Date('2024-02-24')) === 1, 'monthsBetween 1m');
        console.assert(monthsInclusive(new Date('2024-01-24'), new Date('2024-03-24')) === 3, 'monthsInclusive 3m');
        const cfg={ amount:942.42, start:new Date('2024-09-24'), end:new Date('2026-08-24'), loanAPR:0.0257, expAPR:0.08, repayYears:35, investYears:39, ownAmount:100, ownFreq:'monthly', initialOwn:500, payFromPortfolio:false, inflOn:false, inflAPR:0, fxOn:false, fxTotal:0 };
        const s=simulate(cfg); const last=s.arrPort.length-1; console.assert(Number.isFinite(s.arrPort[last]), 'arrPort finite'); console.assert(s.arrInlegOwn[0] >= 500, 'initial own deposit included');
      }catch(e){ console.warn('Self-tests warning:', e); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      setDefaultDates();
      wireInputs();
      setTimeout(()=>{ ensureChart(); update(); selfTests(); }, 0);
    });
  </script>
</body>
</html>
