<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DUO → S&P500 simulatie</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  <style>
    :root{
      --bg:#0f1420; --panel:rgba(255,255,255,.06); --text:#e9edf3; --muted:#9fb1c7;
      --accent:#6ea8fe; --accent2:#60d394; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --radius:10px; --radius-input:12px; --chip-w:210px;
      --line-portfolio:#60d394; --line-netto:#8ab4ff; --line-debt:#ff7b7b; --thead-bg: color-mix(in oklab, var(--bg), white 6%); --firstcol-bg: color-mix(in oklab, var(--bg), white 4%);
    }
    body.light{ --bg:#f4f7fb; --panel:rgba(0,0,0,.04); --text:#0d1117; --muted:#4b5563; --accent:#2563eb; --accent2:#16a34a; --line-portfolio:#16a34a; --line-netto:#2563eb; --line-debt:#ef4444; --thead-bg:color-mix(in oklab, var(--bg), black 4%); --firstcol-bg:color-mix(in oklab, var(--bg), black 2%); }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);
      background:radial-gradient(1200px 600px at 80% -10%, rgba(110,168,254,.20), transparent 60%),radial-gradient(1000px 800px at 0% 100%, rgba(96,211,148,.20), transparent 60%), var(--bg);}    
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(14px) saturate(140%);background:linear-gradient(180deg, color-mix(in oklab, var(--bg), #000 10%), color-mix(in oklab, var(--bg), transparent 40%));border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0;font-weight:700;letter-spacing:.2px;font-size:1.35rem}
    .sub{color:var(--muted);font-size:.92rem}

    .grid{display:grid;gap:16px;grid-template-columns:minmax(360px,1fr) minmax(720px,1.6fr)}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:hidden}
    .card-settings{overflow:visible}
    .card h2{margin:0 0 10px;font-size:1.05rem}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--muted);font-size:.85rem;line-height:1}
    .badge.on{color:#fff;border-color:color-mix(in oklab,var(--accent),#fff 10%);background:color-mix(in oklab,var(--accent),transparent 85%)}

    .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;align-items:start}
    .field{display:grid;grid-template-rows:auto 44px;gap:6px}
    .field label{font-size:.9rem;color:var(--muted);line-height:1.2}
    input[type="number"],input[type="date"],select{height:44px;border-radius:var(--radius-input);border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:var(--text);padding:0 12px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);font-variant-numeric:tabular-nums}

    .row-slider{grid-column:1/-1;display:grid;grid-template-columns:auto 1fr 92px;gap:12px;align-items:center}
    input[type="range"]{height:36px;accent-color:var(--accent)}
    .slider-val{font-variant-numeric:tabular-nums;color:var(--muted);min-width:72px;text-align:right}

    .toggles{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0;justify-content:flex-start}
    .tgl{display:inline-flex;gap:10px;align-items:center;user-select:none;cursor:pointer;padding:6px 16px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);height:44px;min-width:var(--chip-w);justify-content:flex-start}
    .tgl input{position:absolute;opacity:0;width:1px;height:1px}
    .tgl .track{position:relative;width:60px;height:28px;border-radius:999px;background:rgba(255,255,255,.14);box-shadow:inset 0 1px 2px rgba(0,0,0,.25);transition:background .2s;flex:0 0 60px;margin-right:10px}
    .tgl .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#d1d5db;transition:transform .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    .tgl input:checked + .track{background:color-mix(in oklab,var(--accent),white 8%)}
    .tgl input:checked + .track .thumb{transform:translateX(32px);background:#fff}
    .tgl .txt{font-size:.92rem;white-space:nowrap}

    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;align-items:stretch}
    @media(max-width:1100px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);display:grid;grid-template-rows:auto 1fr auto;aspect-ratio:1/1;overflow:hidden}
    .kpi .label{color:var(--muted);font-size:.95rem;font-weight:600}
    .kpi .value{font-size:1.35rem;font-variant-numeric:tabular-nums;margin-top:6px}
    .kpi .tag{margin-top:10px;font-size:.88rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis}

    .chart-wrap{position:relative;width:100%;height:360px}
    @media(max-width:980px){.chart-wrap{height:280px}}
    #chart{display:block;width:100% !important;height:100% !important}

    .tbl-wrap{overflow:auto;max-height:55vh;border-radius:var(--radius);border:1px solid rgba(255,255,255,.06)}
    table{width:100%;border-collapse:separate;border-spacing:0;font-variant-numeric:tabular-nums}
    td,th{padding:10px;border-bottom:1px dashed rgba(255,255,255,.08);text-align:right;background:transparent}
    thead th{color:var(--muted);font-weight:600;position:sticky;top:0;z-index:3;background:var(--thead-bg);backdrop-filter:saturate(130%) blur(4px);box-shadow:inset 0 -1px 0 rgba(255,255,255,.08)}
    th:first-child,td:first-child{position:sticky;left:0;z-index:2;background:var(--firstcol-bg);text-align:left}
    thead th:first-child{z-index:4}

    /* 3-op-een-rij serie-toggles boven de grafiek */
    #seriesToggles{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;align-items:stretch;margin:10px 0}
    #seriesToggles .tgl{min-width:0;width:100%;justify-content:flex-start;align-items:center;text-align:left;padding-inline:12px}
    #seriesToggles .track{margin-right:10px}
    @media(max-width:900px){#seriesToggles{grid-template-columns:1fr 1fr}}
    @media(max-width:560px){#seriesToggles{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>DUO → S&P500 simulatie</h1>
      <div class="sub">Interactief inzicht in lenen bij DUO en beleggen in de S&P 500 — realtime, lokaal, met dark‑mode.</div>
    </div>
  </header>

  <main class="wrap" style="padding-top:14px;">
    <div class="grid">
      <!-- INSTELLINGEN -->
      <section class="card card-settings">
        <h2>Instellingen</h2>
        <div class="controls">
          <div class="field">
            <label>Maandbedrag lenen (€)</label>
            <input id="inpAmount" type="number" min="0" step="1" value="724" />
          </div>
          <div class="field">
            <label>DUO‑rente per jaar (%)</label>
            <input id="inpLoanAPR" type="number" min="0" step="0.01" value="2.57" />
          </div>
          <div class="field">
            <label>Startdatum lening (eerste uitkering)</label>
            <input id="inpStart" type="date" />
          </div>
          <div class="field">
            <label>Einde studie / laatste DUO‑uitkering</label>
            <input id="inpEnd" type="date" />
          </div>

          <div class="row-slider">
            <label for="inpRepayYears">Looptijd terugbetaling (jaren)</label>
            <input id="inpRepayYears" type="range" min="1" max="35" step="1" value="35" />
            <div class="slider-val" id="repayYearsOut">35 jaar</div>
          </div>

          <div class="row-slider">
            <label for="inpInvestYears">Beleggingshorizon (jaren)</label>
            <input id="inpInvestYears" type="range" min="1" max="50" step="1" value="35" />
            <div class="slider-val" id="investYearsOut">35 jaar</div>
          </div>

          <div class="field">
            <label>Verwacht S&P500‑rendement p/j (%)</label>
            <select id="selReturn">
              <option value="6">6%</option>
              <option value="8" selected>8%</option>
              <option value="10">10%</option>
              <option value="custom">Aangepast…</option>
            </select>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <input id="inpCustomReturn" type="number" step="0.1" placeholder="Eigen %" style="display:none" />
          </div>

          <div class="field">
            <label>Eigen inleg (€)</label>
            <input id="inpOwn" type="number" min="0" step="1" value="0" />
          </div>
          <div class="field">
            <label>Frequentie eigen inleg</label>
            <select id="selOwnFreq">
              <option value="monthly" selected>Maandelijks</option>
              <option value="weekly">Wekelijks</option>
              <option value="off">Uit</option>
            </select>
          </div>

          <div class="field">
            <label>Inflatie p/j (%)</label>
            <input id="inpInflAPR" type="number" min="0" step="0.1" value="2.1" />
          </div>
          <div class="field">
            <label>USD/EUR drift p/j (%)</label>
            <input id="inpFXAPR" type="number" step="0.1" value="0" />
          </div>
        </div>

        <div class="toggles">
          <label class="tgl" id="tglPayWrap" role="switch" aria-checked="false">
            <input id="tglPay" type="checkbox" />
            <span class="track"><span class="thumb"></span></span>
            <span class="txt">Schuld betalen uit portefeuille</span>
          </label>
          <label class="tgl" id="tglInflWrap" role="switch" aria-checked="false">
            <input id="tglInfl" type="checkbox" />
            <span class="track"><span class="thumb"></span></span>
            <span class="txt">Inflatie‑correctie</span>
          </label>
          <label class="tgl" id="tglDarkWrap" role="switch" aria-checked="true">
            <input id="tglDark" type="checkbox" checked />
            <span class="track"><span class="thumb"></span></span>
            <span class="txt">Donkere modus</span>
          </label>
        </div>

        <div class="sub" style="margin-top:6px">Aanname: 24 maanden aanloopfase na <strong>einde studie/laatste DUO‑uitkering</strong>. Rente maandelijks samengesteld. Aflossing annuïtair over de gekozen looptijd. FX‑drift werkt door in de portefeuille (USD→EUR).</div>
        <div class="toolbar" style="margin-top:12px; gap:8px; flex-wrap:wrap;">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </section>

      <!-- SIMULATIE -->
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <h2 style="margin:0">Simulatie</h2>
          <span id="viewModeBadge" class="badge">Nominaal</span>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="label">Totale inleg</div><div class="value" id="kInleg">€ 0</div><div class="tag" id="kMonths">—</div></div>
          <div class="kpi"><div class="label">Totale extern betaalde DUO</div><div class="value" id="kExternal">€ 0</div><div class="tag">Aflossingen buiten portefeuille</div></div>
          <div class="kpi"><div class="label">Eindwaarde portefeuille</div><div class="value" id="kPort">€ 0</div><div class="tag" id="kPortTag">—</div></div>
          <div class="kpi"><div class="label">Netto resultaat</div><div class="value" id="kNetto">€ 0</div><div class="tag">≈ Eindportefeuille – extern betaalde DUO</div></div>
        </div>

        <div class="toggles" id="seriesToggles">
          <label class="tgl" id="wrapNet" role="switch" aria-checked="true"><input id="togNet" type="checkbox" checked><span class="track"><span class="thumb"></span></span><span class="txt">Netto</span></label>
          <label class="tgl" id="wrapPort" role="switch" aria-checked="true"><input id="togPort" type="checkbox" checked><span class="track"><span class="thumb"></span></span><span class="txt">Portefeuille</span></label>
          <label class="tgl" id="wrapDebt" role="switch" aria-checked="false"><input id="togDebt" type="checkbox"><span class="track"><span class="thumb"></span></span><span class="txt">Schuld (overlay)</span></label>
        </div>

        <div class="chart-wrap"><canvas id="chart"></canvas></div>
        <div class="sub" style="margin-top:10px" id="phaseNote">—</div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <h2 style="margin:0">Maandelijkse details</h2>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="sub">Weergave</span>
          <select id="selTableView">
            <option value="month" selected>Maandelijks</option>
            <option value="quarter">Per kwartaal</option>
            <option value="year">Per jaar (kalender)</option>
          </select>
        </div>
      </div>
      <div class="sub" style="margin:8px 0">Scroll in de tabel; kop én eerste kolom blijven zichtbaar. Wissel tussen maand/kwartaal/jaar.</div>
      <div class="tbl-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Periode</th>
              <th>Inleg (€)</th>
              <th>Eigen inleg (€)</th>
              <th>Aflossing DUO (€)</th>
              <th>Extern betaald (€)</th>
              <th>Rente DUO (som) (€)</th>
              <th>Schuld einde periode (€)</th>
              <th>Portefeuille einde periode (€)</th>
              <th>Saldo (portf − schuld) (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const gi = (id) => document.getElementById(id);
    const setText = (id, txt) => { const el = gi(id); if (el) el.textContent = txt; };
    const setHTML = (id, html) => { const el = gi(id); if (el) el.innerHTML = html; };
    const euro = (v) => v.toLocaleString('nl-NL', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const euro2 = (v) => v.toLocaleString('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const getCSS = (n) => getComputedStyle(document.body).getPropertyValue(n).trim();
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    function addMonths(date, n) { const d = new Date(date.getTime()); const day = d.getDate(); d.setMonth(d.getMonth() + n); if (d.getDate() !== day) d.setDate(0); return d; }
    function monthsBetween(a, b) { let y = b.getFullYear() - a.getFullYear(); let m = b.getMonth() - a.getMonth(); let t = y * 12 + m; if (b.getDate() < a.getDate()) t -= 1; return Math.max(0, t); }
    function monthsInclusive(start, end) { let c = 0, cur = new Date(start); while (cur <= end) { c++; cur = addMonths(cur, 1); } return c; }

    // ===== Read inputs =====
    function getInputs() {
      const amount = Math.max(0, Number(gi('inpAmount')?.value?.replace(',', '.') ?? 0) || 0);
      const loanAPR = Math.max(0, Number(gi('inpLoanAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const inflAPR = Math.max(0, Number(gi('inpInflAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const fxAPR = (Number(gi('inpFXAPR')?.value?.replace(',', '.') ?? 0) || 0) / 100;
      const startStr = gi('inpStart')?.value || '';
      const endStr = gi('inpEnd')?.value || '';
      const start = startStr ? new Date(startStr) : new Date();
      const end = endStr ? new Date(endStr) : new Date();
      const retSel = gi('selReturn')?.value || '8';
      let expAPR = (retSel === 'custom') ? ((Number(gi('inpCustomReturn')?.value?.replace(',', '.') ?? 0) || 0) / 100) : (Number(retSel) / 100);
      expAPR = Math.max(0, expAPR);
      const repayYears = clamp(parseInt(gi('inpRepayYears')?.value || '35', 10), 1, 35);
      const investYears = clamp(parseInt(gi('inpInvestYears')?.value || '35', 10), 1, 50);
      const ownAmount = Math.max(0, Number(gi('inpOwn')?.value?.replace(',', '.') ?? 0) || 0);
      const ownFreq = gi('selOwnFreq')?.value || 'monthly'; // 'monthly' | 'weekly' | 'off'
      const payFromPortfolio = !!gi('tglPay')?.checked; // AAN = uit portefeuille
      const inflOn = !!gi('tglInfl')?.checked;
      const tableView = gi('selTableView')?.value || 'month';
      return { amount, start, end, loanAPR, expAPR, repayYears, investYears, ownAmount, ownFreq, payFromPortfolio, inflOn, inflAPR, fxAPR, tableView };
    }

    // ===== Core simulation (nominaal) =====
    function simulate(cfg) {
      const rL = Math.pow(1 + cfg.loanAPR, 1 / 12) - 1; // loan monthly
      const rI = Math.pow(1 + cfg.expAPR, 1 / 12) - 1;  // invest monthly
      const rFX = Math.pow(1 + cfg.fxAPR, 1 / 12) - 1;  // USD/EUR drift monthly (positief = USD sterker → hogere EUR-waarde)

      const monthsBorrowed = monthsInclusive(cfg.start, cfg.end); // inclusive DUO
      const grad = cfg.end; const graceEnd = addMonths(grad, 24);
      const repayStartDate = addMonths(graceEnd, 1);
      const repayStartIdx = monthsBetween(cfg.start, repayStartDate);
      const repayMonths = cfg.repayYears * 12;
      const monthsInvest = cfg.investYears * 12; // looptijd beleggen

      // Einde simulatie is max van aflosperiode en beleggingshorizon (en minimaal iets na DUO)
      const totalMonths = Math.max(repayStartIdx + repayMonths, monthsInvest, monthsBorrowed + 6);

      function dryRun(monthsEnd){ let p=0; for(let i=0;i<monthsEnd;i++){ const c=(i<monthsBorrowed)?cfg.amount:0; p+=c; const interest=p*rL; p+=interest; } return {B0:p}; }
      const {B0} = dryRun(repayStartIdx);
      const r=rL, N=repayMonths; const P = (N>0) ? (r>0 ? B0 * (r / (1 - Math.pow(1+r, -N))) : (B0 / N)) : 0;

      const ownMonthly = (cfg.ownFreq==='monthly') ? cfg.ownAmount : (cfg.ownFreq==='weekly' ? cfg.ownAmount * (52/12) : 0);

      let principal=0, portfolio=0, totalInterest=0, totalInleg=0, totalDUOInleg=0, totalOwnInleg=0;
      const labels=[], arrPort=[], arrDebt=[], arrNet=[], arrPay=[], arrInt=[], arrExternalPay=[], arrPortfolioPay=[], arrInlegDuo=[], arrInlegOwn=[], arrInlegTotal=[];
      let depletedAt=null;

      for (let i=0;i<totalMonths;i++){
        const date = addMonths(cfg.start, i); const label = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`; labels.push(label);
        const cDuo = (i < monthsBorrowed) ? cfg.amount : 0;
        const cOwn = (i < monthsInvest) ? ownMonthly : 0;
        const contribute = cDuo + cOwn;

        principal += cDuo; // eigen inleg vergroot géén schuld
        totalDUOInleg += cDuo; totalOwnInleg += cOwn; totalInleg += contribute;

        const interest = principal * rL; principal += interest; totalInterest += interest;

        let pay=0, payFromPort=0, payExternal=0; if (i >= repayStartIdx) { pay = Math.min(P, principal); principal -= pay; }
        portfolio += contribute; if (cfg.payFromPortfolio && pay>0){ payFromPort = Math.min(pay, portfolio); portfolio -= payFromPort; if (payFromPort < pay) payExternal = pay - payFromPort; if (portfolio <= 0 && depletedAt === null){ depletedAt = date; portfolio = Math.max(0, portfolio); } } else { payExternal = pay; }
        portfolio *= (1 + rI) * (1 + rFX);
        const net = portfolio - principal;

        arrPort.push(portfolio||0); arrDebt.push(principal||0); arrNet.push(net||0); arrPay.push(pay||0); arrInt.push(interest||0); arrExternalPay.push(payExternal||0); arrPortfolioPay.push(payFromPort||0);
        arrInlegDuo.push(cDuo); arrInlegOwn.push(cOwn); arrInlegTotal.push(contribute);
      }

      const endPortfolio = portfolio; const endDebt = principal;
      const totalPaid = arrPay.reduce((a,b)=>a+b,0); const totalExternal = arrExternalPay.reduce((a,b)=>a+b,0); const totalFromPortfolio = arrPortfolioPay.reduce((a,b)=>a+b,0);

      return { labels, arrPort, arrDebt, arrNet, arrPay, arrInt, arrExternalPay, arrPortfolioPay, arrInlegDuo, arrInlegOwn, arrInlegTotal,
        totals: { monthsBorrowed, monthsInvest, totalInleg, totalDUOInleg, totalOwnInleg, totalInterest, endPortfolio, endDebt, totalPaid, totalExternal, totalFromPortfolio, netResult: endPortfolio - totalExternal },
        meta: { grad, repayStartDate, graceEnd, monthlyPayment: P, depletedAt, repayEndDate: addMonths(repayStartDate, repayMonths), investEndDate: addMonths(cfg.start, monthsInvest) } };
    }

    // ===== Deflatie helper (reële weergave) =====
    function deflateView(sim, inflAPR){
      const rInf = Math.pow(1 + inflAPR, 1/12) - 1;
      const df = (i) => 1 / Math.pow(1 + rInf, i);
      const mapA = (arr) => arr.map((v,i)=> v*df(i));
      return {
        ...sim,
        arrPort: mapA(sim.arrPort),
        arrDebt: mapA(sim.arrDebt),
        arrNet:  mapA(sim.arrNet),
        arrPay:  mapA(sim.arrPay),
        arrInt:  mapA(sim.arrInt),
        arrExternalPay: mapA(sim.arrExternalPay),
        arrPortfolioPay: mapA(sim.arrPortfolioPay),
        arrInlegDuo: mapA(sim.arrInlegDuo),
        arrInlegOwn: mapA(sim.arrInlegOwn),
        arrInlegTotal: mapA(sim.arrInlegTotal)
      };
    }

    // ===== Table aggregation =====
    function groupRows(sim){ const mode=gi('selTableView')?.value||'month'; const rows=[]; const pushRow=(key,idxs)=>{ const lastIdx=idxs[idxs.length-1]; const sum=(arr)=>idxs.reduce((a,i)=>a+(arr[i]||0),0); rows.push({ key, inleg: sum(sim.arrInlegTotal), inlegOwn: sum(sim.arrInlegOwn), pay: sum(sim.arrPay), external: sum(sim.arrExternalPay), rente: sum(sim.arrInt), schuld: sim.arrDebt[lastIdx], port: sim.arrPort[lastIdx], saldo: sim.arrNet[lastIdx] }); };
      if (mode==='month'){ for (let i=0;i<sim.labels.length;i++) pushRow(sim.labels[i],[i]); }
      else if (mode==='quarter'){ const groups={}; for (let i=0;i<sim.labels.length;i++){ const d=addMonths(new Date(gi('inpStart')?.value||Date.now()), i); const q=Math.floor(d.getMonth()/3)+1; const key=`${d.getFullYear()} Q${q}`; if(!groups[key]) groups[key]=[]; groups[key].push(i);} Object.keys(groups).forEach(k=>pushRow(k, groups[k])); }
      else { const groups={}; for (let i=0;i<sim.labels.length;i++){ const d=addMonths(new Date(gi('inpStart')?.value||Date.now()), i); const key=`${d.getFullYear()}`; if(!groups[key]) groups[key]=[]; groups[key].push(i);} Object.keys(groups).forEach(k=>pushRow(k, groups[k])); }
      return rows; }

    // ===== Chart =====
    let chart;
    function ensureChart(){
      if (chart) return chart;
      const ctx = gi('chart');
      if (!ctx || !window.Chart) return null;
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [
          { label:'Portefeuille', data: [], tension:.25, borderWidth:1.8, fill:false, borderColor:getCSS('--line-portfolio'), pointRadius:0, hidden:false },
          { label:'Netto', data: [], tension:.25, borderWidth:1.8, fill:false, borderColor:getCSS('--line-netto'), pointRadius:0, hidden:false },
          { label:'Schuld (overlay)', data: [], tension:.2, borderWidth:1.2, fill:false, borderColor:getCSS('--line-debt'), pointRadius:0, borderDash:[6,4], hidden:true }
        ]},
        options: { responsive:true, maintainAspectRatio:false, animations:{ duration:200 }, elements:{ point:{ radius:0 } }, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>{ const ds=ctx.dataset.label; const v=ctx.parsed.y||0; return `${ds}: ${euro2(v)}`; } } } }, scales:{ y:{ beginAtZero:false }, x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:10 } } } }
      });
      return chart;
    }
    const applyChartTheme=()=>{ if(!chart) return; const d=chart.data.datasets; d[0].borderColor=getCSS('--line-portfolio'); d[1].borderColor=getCSS('--line-netto'); d[2].borderColor=getCSS('--line-debt'); chart.update('none'); };

    // ===== Renderers =====
    function renderTable(sim){ const tbody=document.querySelector('#tbl tbody'); if(!tbody) return; const rows=groupRows(sim); tbody.innerHTML=rows.map(r=>`<tr><td>${r.key}</td><td>${euro2(r.inleg)}</td><td>${euro2(r.inlegOwn)}</td><td>${euro2(r.pay)}</td><td>${euro2(r.external)}</td><td>${euro2(r.rente)}</td><td>${euro2(r.schuld)}</td><td>${euro2(r.port)}</td><td>${euro2(r.saldo)}</td></tr>`).join(''); }

    function update(){
      // Outputs naast sliders
      setText('repayYearsOut', `${gi('inpRepayYears')?.value||''} jaar`);
      setText('investYearsOut', `${gi('inpInvestYears')?.value||''} jaar`);

      const cfg=getInputs();
      const simNom = simulate(cfg);
      const sim = cfg.inflOn ? deflateView(simNom, cfg.inflAPR) : simNom;

      // KPI's (nominaal of reëel afhankelijk van toggle)
      const last = sim.labels.length - 1;
      const sum = (a)=>a.reduce((x,y)=>x+y,0);
      const totalInleg = sum(sim.arrInlegTotal);
      const totalExternal = sum(sim.arrExternalPay);
      const endPortfolio = sim.arrPort[last]||0;
      const netResult = endPortfolio - totalExternal;

      setText('kInleg', euro(totalInleg));
      const ownActive = sum(sim.arrInlegOwn)>0 ? ' • eigen inleg actief' : '';
      setText('kMonths', `${simNom.totals.monthsBorrowed} maanden DUO${ownActive}`);
      setText('kPort', euro(endPortfolio));
      setText('kExternal', euro(totalExternal));
      setText('kNetto', euro(netResult));
      const badge = gi('viewModeBadge');
      if (badge){ if (cfg.inflOn){ badge.textContent = 'Reëel (inflatie)'; badge.classList.add('on'); } else { badge.textContent = 'Nominaal'; badge.classList.remove('on'); } }
      setText('kPortTag', cfg.payFromPortfolio ? (simNom.meta.depletedAt?`Aflossingen uit portefeuille • leeg in ${simNom.meta.depletedAt.getFullYear()}-${String(simNom.meta.depletedAt.getMonth()+1).padStart(2,'0')}`:'Aflossingen uit portefeuille') : 'Aflossingen extern betaald');

      const fmt=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      setHTML('phaseNote', `Einde studie/laatste uitkering: <strong>${fmt(simNom.meta.grad)}</strong> • Aanloopfase tot: <strong>${fmt(simNom.meta.graceEnd)}</strong> • Start aflossen: <strong>${fmt(simNom.meta.repayStartDate)}</strong> • Maandtermijn DUO: <strong>${euro2(simNom.meta.monthlyPayment)}</strong> • Einde aflossen: <strong>${fmt(simNom.meta.repayEndDate)}</strong> • <em>Beleggingshorizon eindigt</em>: <strong>${fmt(simNom.meta.investEndDate)}</strong>${cfg.inflOn?' • weergave: reëel (prijspeil startdatum)':''}`);

      renderTable(sim);

      // Chart
      const ch = ensureChart();
      if (ch){
        ch.data.labels = sim.labels;
        ch.data.datasets[0].data = sim.arrPort;
        ch.data.datasets[1].data = sim.arrNet;
        ch.data.datasets[2].data = sim.arrDebt.map(v=>-v); // schuld onder nul

        ch.data.datasets[0].hidden = !gi('togPort')?.checked;
        ch.data.datasets[1].hidden = !gi('togNet')?.checked;
        ch.data.datasets[2].hidden = !gi('togDebt')?.checked;

        // y-as: standaard 0; als Schuld aanstaat schaalt hij mee naar beneden
        let yMin = 0; if (gi('togDebt')?.checked){ const minDebt = Math.min(...ch.data.datasets[2].data, 0); yMin = Math.floor((minDebt*1.05)/100)*100; }
        const visible = []; if(gi('togPort')?.checked) visible.push(...ch.data.datasets[0].data); if(gi('togNet')?.checked) visible.push(...ch.data.datasets[1].data); const yMax = visible.length? Math.max(...visible, 0) : 0;
        ch.options.scales.y.min = yMin; ch.options.scales.y.suggestedMax = yMax*1.05;

        ch.update(); applyChartTheme();
      }
    }

    // ===== Events & defaults =====
    function setDefaultDates(){ const start=new Date('2024-08-24'); const end=new Date('2026-07-24'); const s=gi('inpStart'); const e=gi('inpEnd'); if(s) s.value=`${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`; if(e) e.value=`${end.getFullYear()}-${String(end.getMonth()+1).padStart(2,'0')}-${String(end.getDate()).padStart(2,'0')}`; }

    function wireToggleInput(inputId, wrapId, onChange){ const inp=gi(inputId); const wrap=gi(wrapId); if(!inp||!wrap) return; const sync=()=>wrap.setAttribute('aria-checked', String(!!inp.checked)); inp.addEventListener('change', ()=>{ if(inputId==='tglDark'){ document.body.classList.toggle('light', !inp.checked); } sync(); onChange&&onChange(); }); sync(); }
    function wireChartToggle(id,wrapId){ const inp=gi(id); const wrap=gi(wrapId); if(!inp||!wrap) return; const sync=()=>wrap.setAttribute('aria-checked', String(!!inp.checked)); inp.addEventListener('change', ()=>{ sync(); update(); }); sync(); }

    function wireInputs(){
      ['inpAmount','inpLoanAPR','inpStart','inpEnd','inpRepayYears','inpInvestYears','selReturn','inpCustomReturn','selOwnFreq','inpOwn','selTableView','inpInflAPR','inpFXAPR']
        .forEach(id=>{ const el=gi(id); if(!el) return; el.addEventListener('input',()=>{ if(id==='selReturn'){ const s=gi('selReturn'); const c=gi('inpCustomReturn'); if(s&&c){ c.style.display = s.value==='custom' ? 'block' : 'none'; } } update(); }); el.addEventListener('change', update); });
      wireToggleInput('tglPay','tglPayWrap', update);
      wireToggleInput('tglInfl','tglInflWrap', update);
      wireToggleInput('tglDark','tglDarkWrap', ()=>{ applyChartTheme(); update(); });
      wireChartToggle('togNet','wrapNet'); wireChartToggle('togPort','wrapPort'); wireChartToggle('togDebt','wrapDebt');
      const btn=gi('btnReset'); if(btn){ btn.addEventListener('click', (e)=>{ e.preventDefault(); setDefaultDates(); const set=(id,val)=>{ const el=gi(id); if(el) el.value=val; }; set('inpAmount',724); set('inpLoanAPR',2.57); const sr=gi('selReturn'); if(sr) sr.value='8'; set('inpCustomReturn',''); set('inpRepayYears',35); set('inpInvestYears',35); setText('repayYearsOut','35 jaar'); setText('investYearsOut','35 jaar'); set('inpOwn',0); const of=gi('selOwnFreq'); if(of) of.value='monthly'; set('inpInflAPR',2.1); set('inpFXAPR',0); const ck=(id,val)=>{ const el=gi(id); if(el){ el.checked=val; el.dispatchEvent(new Event('change')); } }; ck('tglPay',false); ck('tglInfl',false); ck('tglDark',true); ck('togNet',true); ck('togPort',true); ck('togDebt',false); update(); }); }
    }

    function selfTests(){
      try{
        // DOM presence tests
        const ids = ['inpAmount','inpLoanAPR','inpStart','inpEnd','inpRepayYears','repayYearsOut','inpInvestYears','investYearsOut','selReturn','inpOwn','selOwnFreq','tglPay','tglInfl','tglDark','viewModeBadge','kInleg','kExternal','kPort','kNetto','kPortTag','phaseNote','chart','tbl'];
        const missing = ids.filter(id=>!gi(id));
        if(missing.length){ console.warn('DOM check: missing elements:', missing); }
        // Logic tests
        console.assert(monthsBetween(new Date('2024-01-24'), new Date('2024-02-24')) === 1, 'monthsBetween 1m');
        console.assert(monthsInclusive(new Date('2024-01-24'), new Date('2024-03-24')) === 3, 'monthsInclusive 3m');
        const cfg = { amount: 1000, start: new Date('2024-01-24'), end: new Date('2024-12-24'), loanAPR: 0.03, expAPR: 0.07, repayYears: 1, investYears: 2, ownAmount: 25, ownFreq:'weekly', payFromPortfolio: false, inflOn: true, inflAPR: 0.02, fxAPR: 0.01 };
        const out = simulate(cfg);
        const outR = deflateView(out, 0.02);
        const ok = [out.arrPort, out.arrDebt, out.arrNet, out.arrPay].every(a => a.every(v => Number.isFinite(v)));
        console.assert(ok, 'arrays contain finite numbers');
        console.assert(outR.arrPort[10] <= out.arrPort[10], 'deflation lowers nominal');
      }catch(e){ console.warn('Self-tests warning:', e); }
    }

    // Boot
    document.addEventListener('DOMContentLoaded', ()=>{
      setDefaultDates();
      wireInputs();
      // In sommige omgevingen is Chart pas na defer beschikbaar; kleine delay voor zekerheid
      setTimeout(()=>{ ensureChart(); update(); selfTests(); }, 0);
    });
  </script>
</body>
</html>
